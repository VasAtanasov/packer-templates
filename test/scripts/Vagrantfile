Vagrant.configure("2") do |config|
  box_name = ENV["BOX_NAME"] || "debian"

  config.vm.box = box_name
  config.vm.box_version = ENV["BOX_VERSION"] if ENV["BOX_VERSION"] || "13.3"
  config.vm.hostname = "test-#{box_name}"

  config.vm.synced_folder ".", "/vagrant"
  config.vm.synced_folder "../../packer_templates/scripts", "/scripts"

  # Run BATS tests inside the VM
  config.vm.provision "shell", inline: <<-SHELL
    set -euo pipefail
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -y -qq
    apt-get install -y -qq --no-install-recommends bats
    install -d -m 0755 /usr/local/lib/scripts/_common
    install -m 0644 /scripts/_common/lib-core.sh /usr/local/lib/scripts/_common/lib-core.sh
    install -m 0644 /scripts/_common/lib-debian.sh /usr/local/lib/scripts/_common/lib-debian.sh
    install -m 0644 /scripts/_common/lib-rhel.sh /usr/local/lib/scripts/_common/lib-rhel.sh

    # Run BATS with test environment variables
    SCRIPTS_DIR=/scripts \
    LIB_CORE_SH=/usr/local/lib/scripts/_common/lib-core.sh \
    LIB_OS_SH=/usr/local/lib/scripts/_common/lib-debian.sh \
    LIB_DIR=/usr/local/lib/k8s \
    bats -r /vagrant/tests || exit 1
  SHELL
end

